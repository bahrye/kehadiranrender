<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ceklok Guru - Firebase Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 min-h-screen p-4">

    <div id="loginSection" class="max-w-md mx-auto mt-20 bg-white p-8 rounded-3xl shadow-xl">
        <h2 class="text-2xl font-bold text-center mb-6 text-slate-800">Login Firebase</h2>
        <div class="space-y-4">
            <input type="text" id="username" placeholder="Username (NIP)" class="w-full p-3 border rounded-xl outline-none focus:ring-2 focus:ring-orange-500">
            <input type="password" id="password" placeholder="Password" class="w-full p-3 border rounded-xl outline-none focus:ring-2 focus:ring-orange-500">
            <button id="btnLogin" class="w-full bg-orange-600 text-white font-bold py-3 rounded-xl shadow-lg">MASUK</button>
        </div>
    </div>

    <div id="timesheetSection" class="hidden max-w-4xl mx-auto bg-white p-6 rounded-3xl shadow-2xl border border-white">
        <div class="flex justify-between items-center mb-6">
            <button id="prevBtn" class="px-5 py-2 bg-slate-100 rounded-xl hover:bg-slate-200 transition">â—€</button>
            <div class="text-center">
                <h2 id="displayMonthYear" class="text-2xl font-bold text-slate-800"></h2>
                <p id="schoolTitle" class="text-xs text-orange-600 font-bold tracking-widest uppercase"></p>
            </div>
            <button id="nextBtn" class="px-5 py-2 bg-slate-100 rounded-xl hover:bg-slate-200 transition">â–¶</button>
        </div>

        <div class="overflow-x-auto rounded-2xl border">
            <table class="w-full text-left text-sm">
                <thead class="bg-slate-50 text-slate-500 uppercase text-[10px] font-bold">
                    <tr><th class="p-4">Tanggal</th><th class="p-4 text-center">Masuk</th><th class="p-4 text-center">Pulang</th><th class="p-4">Keterangan</th><th class="p-4 text-center">Aksi</th></tr>
                </thead>
                <tbody id="tableBody" class="divide-y divide-slate-100"></tbody>
            </table>
        </div>

        <button id="btnSave" class="w-full mt-6 bg-orange-600 text-white font-bold py-4 rounded-2xl shadow-xl hover:bg-orange-700 transition">ðŸ’¾ SIMPAN SEMUA PERUBAHAN</button>
        <button onclick="localStorage.clear(); location.reload();" class="w-full mt-4 text-xs text-slate-400 underline">Logout</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // 1. MASUKKAN KONFIGURASI FIREBASE ANDA DI SINI
        const firebaseConfig = {
            apiKey: "AIzaSyDT8CyigYFfoVg3DXunOq7pKvbMpTZkQ98",
            authDomain: "cekloknewversion.firebaseapp.com",
            projectId: "cekloknewversion",
            storageBucket: "cekloknewversion.firebasestorage.app",
            messagingSenderId: "602084220497",
            appId: "1:602084220497:web:ac20adef8bb50acef56270"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentDate = new Date();
        let ketOptions = ["Hadir", "Sakit", "Izin", "Cuti", "Libur"]; // Bisa diambil dari Firestore

        // --- FUNGSI LOGIN ---
        window.handleLogin = async () => {
            const user = document.getElementById('username').value;
            const pass = document.getElementById('password').value;

            const userDoc = await getDoc(doc(db, "users", user));
            if (userDoc.exists() && userDoc.data().password === pass) {
                const data = userDoc.data();
                localStorage.setItem('user_ceklok', user);
                localStorage.setItem('nama_guru', data.nama);
                localStorage.setItem('role', data.role);
                localStorage.setItem('sekolah', JSON.stringify(data.sekolah));
                location.reload();
            } else {
                alert("Login Gagal!");
            }
        };

        // --- FUNGSI RENDER TABEL ---
        async function loadData() {
            const user = localStorage.getItem('user_ceklok');
            if(!user) return;
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('timesheetSection').classList.remove('hidden');

            const m = currentDate.getMonth(), y = currentDate.getFullYear();
            const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
            document.getElementById('displayMonthYear').innerText = `${monthNames[m]} ${y}`;
            document.getElementById('schoolTitle').innerText = JSON.parse(localStorage.getItem('sekolah'))[0];

            // Ambil data dari Firebase Firestore
            const q = query(collection(db, "presensi"), where("username", "==", user));
            const querySnapshot = await getDocs(q);
            const logs = [];
            querySnapshot.forEach(doc => logs.push(doc.data()));

            renderTable(logs);
        }

        function renderTable(logs) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            const m = currentDate.getMonth(), y = currentDate.getFullYear();
            const daysInMonth = new Date(y, m + 1, 0).getDate();

            for (let d = 1; d <= daysInMonth; d++) {
                const dateObj = new Date(y, m, d);
                const isSun = dateObj.getDay() === 0;
                const dateKey = `${y}-${(m+1).toString().padStart(2,'0')}-${d.toString().padStart(2,'0')}`;
                const log = logs.find(l => l.tanggal === dateKey) || {};
                
                tbody.innerHTML += `
                    <tr class="${isSun ? 'bg-red-50' : ''}">
                        <td class="p-4 font-bold ${isSun ? 'text-red-500' : ''}">${d}</td>
                        <td class="p-2 text-center"><input type="text" value="${log.masuk||''}" ${isSun ? 'disabled' : ''} class="row-m w-16 p-2 border rounded-xl text-center text-xs ${isSun ? 'bg-gray-100' : ''}"></td>
                        <td class="p-2 text-center"><input type="text" value="${log.pulang||''}" ${isSun ? 'disabled' : ''} class="row-p w-16 p-2 border rounded-xl text-center text-xs ${isSun ? 'bg-gray-100' : ''}"></td>
                        <td class="p-2">
                            <select class="row-k w-full p-2 border rounded-xl text-xs ${isSun ? 'bg-gray-100' : ''}" ${isSun ? 'disabled' : ''}>
                                ${ketOptions.map(o => `<option value="${o}" ${log.keterangan==o?'selected':''}>${o}</option>`).join('')}
                            </select>
                        </td>
                        <td class="p-2 text-center"><input type="hidden" class="row-d" value="${dateKey}"><button onclick="this.closest('tr').querySelectorAll('input,select').forEach(i=>i.value='')" class="text-red-400">Ã—</button></td>
                    </tr>`;
            }
        }

        window.saveAll = async () => {
            const user = localStorage.getItem('user_ceklok');
            const rows = document.querySelectorAll('#tableBody tr');
            for(let tr of rows) {
                const date = tr.querySelector('.row-d').value;
                const m = tr.querySelector('.row-m').value;
                const p = tr.querySelector('.row-p').value;
                const k = tr.querySelector('.row-k').value;

                if(m || p || k !== "Hadir") {
                    await setDoc(doc(db, "presensi", `${user}_${date}`), {
                        username: user, tanggal: date, masuk: m, pulang: p, keterangan: k, nama: localStorage.getItem('nama_guru')
                    });
                }
            }
            alert("Data Berhasil Sinkron!");
        };

        document.getElementById('btnLogin').onclick = window.handleLogin;
        document.getElementById('btnSave').onclick = window.saveAll;
        document.getElementById('prevBtn').onclick = () => { currentDate.setMonth(currentDate.getMonth() - 1); loadData(); };
        document.getElementById('nextBtn').onclick = () => { currentDate.setMonth(currentDate.getMonth() + 1); loadData(); };

        loadData();
    </script>
</body>
</html>
